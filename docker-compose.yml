services:
  # 1. Redis
  redis:
    image: redis:alpine
    container_name: meet-redis
    restart: always
    ports:
      - "6379:6379"

  # 2. Coturn (TURN/STUN)
  coturn:
    image: coturn/coturn:latest
    container_name: meet-coturn
    restart: always
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
    volumes:
      - ./coturn/turnserver.conf:/etc/coturn/turnserver.conf
    environment:
      # On Windows Docker, this needs to be your LAN IP or Public IP (not 127.0.0.1)
      # if you want to test from other devices (like a phone).
      - EXTERNAL_IP=${ANNOUNCED_IP:-127.0.0.1}
    command:
      - -c /etc/coturn/turnserver.conf
      - --external-ip=$${EXTERNAL_IP}

  # 3. Backend (Node 22 + Mediasoup)
  server:
    build: ./server
    container_name: meet-backend
    restart: always
    depends_on:
      - redis
    # Mount the folder for Live Reload
    volumes:
      - ./server:/app
      # CRITICAL: Keep container's node_modules, don't overwrite with local Windows ones
      - /app/node_modules
      # Mount data directory for SQLite database
      - ./server/data:/app/data
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # For Windows Dev: Announced IP must be accessible by the browser (LAN IP or 127.0.0.1)
      - ANNOUNCED_IP=${ANNOUNCED_IP:-127.0.0.1}
      - LISTEN_IP=0.0.0.0
      - PORT=3000
    # Map ports explicitly since we removed network_mode: host
    ports:
      - "3000:3000"
      - "10000-10100:10000-10100/udp"
      - "10000-10100:10000-10100/tcp"
    # Override command to ensure we run in dev mode with hot reload
    command: npm run dev

  # 4. Nginx (Reverse Proxy)
  nginx:
    image: nginx:alpine
    container_name: meet-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./client/dist:/usr/share/nginx/html:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - server
